VEGENIE SERVER SNAPSHOT
====================================


==================================================
[File Path]: docker-compose.yml
==================================================
version: '3.8'

services:
  # 1. PostgreSQL ë°ì´í„°ë² ì´ìŠ¤
  db:
    image: postgres:15-alpine
    container_name: vegenie-db
    restart: always
    environment:
      - POSTGRES_USER=vegenie_user
      - POSTGRES_PASSWORD=vegenie_pass
      - POSTGRES_DB=vegenie_db
      - TZ=Asia/Seoul
    volumes:
      - postgres_data:/var/lib/postgresql/data  # DB ë°ì´í„° ì˜êµ¬ ì €ìž¥
    ports:
      - "5432:5432"  # (ì„ íƒ) ë¡œì»¬ì—ì„œ DB ì ‘ì†í•˜ê³  ì‹¶ì„ ë•Œ

  # 2. Vegenie ì„œë²„
  backend:
    build: .
    container_name: vegenie-server
    restart: always
    depends_on:
      - db
    ports:
      - "8000:8000"
    environment:
      # [ì¤‘ìš”] Postgres ì—°ê²° ë¬¸ìžì—´ (user:pass@container_name:port/db_name)
      - DATABASE_URL=postgresql://vegenie_user:vegenie_pass@db:5432/vegenie_db

      # [ì„¤ì •] ê¸°ì¡´ í‚¤ ê°’ë“¤ (settings.pyê°€ ì´ê±¸ ì½ìŒ)
      - SECRET_KEY=vegenie-secret-key-prod-change-me
      - SOLAPI_KEY=NCS4COIDQ681XXPL
      - SOLAPI_SECRET=4IWZDH2PMMQJXBZRDRA5Z7SQUTP8VFSX
      - TIMEZONE=Asia/Seoul
      - TZ=Asia/Seoul

volumes:
  postgres_data:

==================================================
[File Path]: Dockerfile
==================================================
# 1. ê°€ë³ê³  ì•ˆì •ì ì¸ Python 3.10 ë²„ì „ ì‚¬ìš©
FROM python:3.10-slim

# 2. íƒ€ìž„ì¡´ ì„¤ì • (í•œêµ­ ì‹œê°„) - ì¢€ë¹„ ê°ì§€ ë¡œì§ í•„ìˆ˜!
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 3. ìž‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# 4. ì˜ì¡´ì„± íŒŒì¼ ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 5. ì†ŒìŠ¤ ì½”ë“œ ì „ì²´ ë³µì‚¬
COPY . .

# 6. ì‹¤í–‰ ëª…ë ¹ì–´ (Uvicorn ì‹¤í–‰)
# host 0.0.0.0ì€ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ ì ‘ì† í—ˆìš©ì„ ìœ„í•´ í•„ìˆ˜
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]

==================================================
[File Path]: init_db.py
==================================================
ï»¿import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.db import Base, engine
from app.models.models import User, SalesReport

def init_db():
    print("Vegenie DB ì´ˆê¸°í™” ì¤‘...")
    Base.metadata.create_all(bind=engine)
    print("í…Œì´ë¸” ìƒì„± ì™„ë£Œ: users, sales_reports")

if __name__ == "__main__":
    init_db()


==================================================
[File Path]: requirements.txt
==================================================
fastapi
uvicorn
sqlalchemy
pydantic
pydantic-settings
python-jose[cryptography]
python-multipart
requests
openpyxl
pandas
msoffcrypto-tool
apscheduler
psycopg2-binary

# [ìˆ˜ì •] passlibì™€ bcrypt ë²„ì „ì„ ë¶„ë¦¬í•´ì„œ ëª…ì‹œ
passlib
bcrypt==4.0.1

==================================================
[File Path]: test_complete_scenario.py
==================================================
import requests
import sys
import os
import uuid
import openpyxl
from datetime import date, datetime, timedelta

# ==========================================
# [ì¤‘ìš”] ì„œë²„ ë‚´ë¶€ ëª¨ë“ˆ ë¡œë”©
# ==========================================
sys.path.append(os.getcwd())
from app.db import SessionLocal, engine, Base
# [ì¤‘ìš”] ëª¨ë¸ì„ ìž„í¬íŠ¸í•´ì•¼ Baseê°€ í…Œì´ë¸” ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìžˆìŒ
from app.models.models import User, SalesReport, ReportNotification, Release, SystemLog
from app.core.security import get_password_hash
from app.services.monitoring import MonitoringService
from app.settings import settings

# ==========================================
# 0. ì„¤ì • & ìœ í‹¸ë¦¬í‹°
# ==========================================
BASE_URL = "http://localhost:8000/api/v1"
RUN_ID = str(uuid.uuid4())[:6]
OWNER_USER = f"boss_{RUN_ID}"
ADMIN_USER = f"admin_{RUN_ID}"
PASSWORD = "password123"
TEST_EXCEL_FILE = f"test_sales_{RUN_ID}.xlsx"

# ANSI ìƒ‰ìƒ
GREEN = "\033[92m"
RED = "\033[91m"
BLUE = "\033[94m"
YELLOW = "\033[93m"
RESET = "\033[0m"


def log(msg): print(f"{msg}")


def print_pass(msg): print(f"{GREEN}[PASS]{RESET} {msg}")


def print_fail(msg):
    print(f"{RED}[FAIL]{RESET} {msg}")


# ==========================================
# 1. í—¬í¼ í•¨ìˆ˜
# ==========================================
def create_test_excel():
    """í…ŒìŠ¤íŠ¸ìš© ì—‘ì…€ íŒŒì¼ ìƒì„±"""
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = settings.EXCEL_SHEET_NAME  # "ê²°ì œ í•©ê³„"

    ws.append(["ë‚ ì§œ", "ìŠ¹ì¸ë²ˆí˜¸", "ë§¤ìž…ì‚¬ë³„", "ê¸ˆì•¡", "ë¹„ê³ "])
    data = [
        ["2024-01-01", "1", "ë°°ë‹¬ì˜ë¯¼ì¡±", 10000, ""],
        ["2024-01-01", "2", "ì¿ íŒ¡ì´ì¸ ", 20000, ""],
        ["2024-01-01", "3", "ìš”ê¸°ìš”", 15000, ""],
        ["2024-01-01", "4", "í˜„ê¸ˆ", 5000, ""]
    ]
    for row in data: ws.append(row)
    ws.append(["í•©ê³„", "", "", 50000, ""])
    wb.save(TEST_EXCEL_FILE)
    log(f"ðŸ“„ ì—‘ì…€ ìƒì„± ì™„ë£Œ: {TEST_EXCEL_FILE}")


def get_db_session():
    return SessionLocal()


# ==========================================
# 2. ì‹œë‚˜ë¦¬ì˜¤ ì‹œìž‘
# ==========================================
def run_complete_test():
    print(f"{BLUE}=== Vegenie Server v0.2.5 ì™„ì „íŒ í†µí•© í…ŒìŠ¤íŠ¸ ==={RESET}")
    print(f"Test Run ID: {RUN_ID}\n")

    # ----------------------------------------------------
    # [FIX] DB í…Œì´ë¸” ê°•ì œ ìƒì„± (ì´ ë¶€ë¶„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!)
    # ----------------------------------------------------
    print("âš™ï¸  DB í…Œì´ë¸” í™•ì¸ ë° ìƒì„± ì¤‘...")
    try:
        Base.metadata.create_all(bind=engine)
        print("âœ… DB í…Œì´ë¸” ì¤€ë¹„ ì™„ë£Œ")
    except Exception as e:
        print_fail(f"DB ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        return

    # ----------------------------------------------------
    # [Step 1] íšŒì›ê°€ìž… (Register)
    # ----------------------------------------------------
    log("--- [1] íšŒì›ê°€ìž… í”„ë¡œì„¸ìŠ¤ ---")

    # 1.1 ì‚¬ìž¥ë‹˜ ê°€ìž…
    res = requests.post(f"{BASE_URL}/auth/register", json={
        "username": OWNER_USER,
        "password": PASSWORD,
        "phone": "010-1234-5678",
        "store_name": f"ëŒ€ë°•ë§¤ìž¥_{RUN_ID}"
    })
    if res.status_code == 201:
        print_pass("ì‚¬ìž¥ë‹˜ íšŒì›ê°€ìž… (POST /auth/register)")
    else:
        print_fail(f"ê°€ìž… ì‹¤íŒ¨: {res.text}")

    # 1.2 ê´€ë¦¬ìž ê°€ìž… (DB ì§ì ‘ ì£¼ìž… - Admin API í…ŒìŠ¤íŠ¸ìš©)
    db = get_db_session()
    try:
        admin = User(
            username=ADMIN_USER,
            password_hash=get_password_hash(PASSWORD),
            phone="010-9999-9999",
            store_name="ë³¸ì‚¬",
            role="ADMIN"
        )
        db.add(admin)
        db.commit()
        print_pass("ê´€ë¦¬ìž ê³„ì • ìƒì„± (DB ì£¼ìž…)")
    except Exception as e:
        print_fail(f"ê´€ë¦¬ìž ìƒì„± ì‹¤íŒ¨: {e}")
    finally:
        db.close()

    # 1.3 ë¡œê·¸ì¸
    res = requests.post(f"{BASE_URL}/auth/login", json={"username": OWNER_USER, "password": PASSWORD})
    if res.status_code == 200:
        owner_token = res.json()["access_token"]
        print_pass("ì‚¬ìž¥ë‹˜ ë¡œê·¸ì¸ (POST /auth/login)")
    else:
        print_fail("ë¡œê·¸ì¸ ì‹¤íŒ¨ (ì‚¬ìž¥ë‹˜)")
        return

    admin_res = requests.post(f"{BASE_URL}/auth/login", json={"username": ADMIN_USER, "password": PASSWORD})
    if admin_res.status_code == 200:
        admin_token = admin_res.json()["access_token"]
    else:
        print_fail("ë¡œê·¸ì¸ ì‹¤íŒ¨ (ê´€ë¦¬ìž)")
        return

    owner_headers = {"Authorization": f"Bearer {owner_token}"}
    admin_headers = {"Authorization": f"Bearer {admin_token}"}

    # ----------------------------------------------------
    # [Step 2] ë§¤ì¶œ ì—…ë¡œë“œ & ì•Œë¦¼í†¡ ê²€ì¦
    # ----------------------------------------------------
    log("\n--- [2] ë§¤ì¶œ ë° ì•Œë¦¼í†¡ í”„ë¡œì„¸ìŠ¤ ---")

    create_test_excel()

    # 2.1 íŒŒì¼ ì—…ë¡œë“œ
    today = date.today().isoformat()
    files = {'file': open(TEST_EXCEL_FILE, 'rb')}
    data = {'report_date': today}

    res = requests.post(f"{BASE_URL}/sales/upload", headers=owner_headers, files=files, data=data)
    files['file'].close()

    if res.status_code == 200:
        rj = res.json()
        if rj["total_sales"] == 50000:
            print_pass(f"ë§¤ì¶œ ì—…ë¡œë“œ ì„±ê³µ (Total: {rj['total_sales']})")
        else:
            print_fail(f"ë§¤ì¶œ ê³„ì‚° ì˜¤ë¥˜: {rj}")
    else:
        print_fail(f"ì—…ë¡œë“œ ì—ëŸ¬: {res.text}")

    # 2.2 [DB ê²€ì¦] ì•Œë¦¼í†¡ ê¸°ë¡ í™•ì¸
    db = get_db_session()
    try:
        user = db.query(User).filter(User.username == OWNER_USER).first()

        # ReportNotification í…Œì´ë¸” í™•ì¸
        notif = db.query(ReportNotification).filter(
            ReportNotification.user_id == user.id,
            ReportNotification.report_date == today
        ).first()

        if notif:
            print_pass(f"ì•Œë¦¼í†¡ ê¸°ë¡ ìƒì„± í™•ì¸ (ID: {notif.notif_id}, Status: {notif.primary_status})")
            if notif.primary_status in ["SENT", "FAIL"]:
                print_pass(f" -> ë°œì†¡ ì‹œë„ ê²°ê³¼: {notif.primary_status}")
            else:
                print_fail(f" -> ë°œì†¡ ìƒíƒœ ì´ìƒ: {notif.primary_status}")
        else:
            print_fail("ì•Œë¦¼í†¡ ê¸°ë¡(ReportNotification)ì´ ì—†ìŠµë‹ˆë‹¤!")

        # SystemLog í™•ì¸
        log_entry = db.query(SystemLog).filter(
            SystemLog.type == "ALIMTALK",
            SystemLog.timestamp >= datetime.now() - timedelta(minutes=1)
        ).first()

        if log_entry:
            print_pass(f"ì‹œìŠ¤í…œ ë¡œê·¸ í™•ì¸ (ALIMTALK: {log_entry.status})")
        else:
            # ë¡œê·¸ëŠ” íƒ€ì´ë°ì— ë”°ë¼ ëŠ¦ê²Œ ì°íž ìˆ˜ë„ ìžˆìŒ
            pass

    finally:
        db.close()

    # ----------------------------------------------------
    # [Step 3] ì¡°íšŒ ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    # ----------------------------------------------------
    log("\n--- [3] ì¡°íšŒ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ---")

    # 3.1 ì›”ë³„ ì¡°íšŒ
    month_str = date.today().strftime("%Y-%m")
    res = requests.get(f"{BASE_URL}/sales/monthly", headers=owner_headers, params={"month": month_str})
    if res.status_code == 200 and res.json()["total_accumulated"] == 50000:
        print_pass("ì›”ë³„ ì¡°íšŒ í™•ì¸")
    else:
        print_fail("ì›”ë³„ ì¡°íšŒ ì‹¤íŒ¨")

    # 3.2 ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    res = requests.get(f"{BASE_URL}/sales/export", headers=owner_headers, params={"start": today, "end": today})
    if res.status_code == 200 and "spreadsheet" in res.headers["content-type"]:
        print_pass("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í™•ì¸")
    else:
        print_fail("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨")

    # ----------------------------------------------------
    # [Step 4] ì¢€ë¹„(Zombie) ê°ì§€ ë¡œì§ í…ŒìŠ¤íŠ¸
    # ----------------------------------------------------
    log("\n--- [4] ì¢€ë¹„ ê°ì§€(ì˜¤í”„ë¼ì¸ ì•Œë¦¼) í…ŒìŠ¤íŠ¸ ---")

    # 4.1 ìƒì¡´ ì‹ ê³  (Heartbeat)
    res = requests.post(f"{BASE_URL}/auth/heartbeat", headers=owner_headers)
    if res.status_code == 200:
        print_pass("í•˜íŠ¸ë¹„íŠ¸ ì „ì†¡ ì„±ê³µ (Alive)")

    # 4.2 [ì„œë²„ ì¡°ìž‘] ì‹œê°„ì„ 10ë¶„ ì „ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
    db = get_db_session()
    user = db.query(User).filter(User.username == OWNER_USER).first()

    past_time = datetime.now() - timedelta(minutes=10)
    user.last_heartbeat = past_time
    user.is_offline_notified = False
    db.commit()
    print_pass(f"ðŸ˜ˆ DB ì¡°ìž‘: ì‚¬ìš©ìžì˜ ë§ˆì§€ë§‰ ì ‘ì† ì‹œê°„ì„ 10ë¶„ ì „ìœ¼ë¡œ ë³€ê²½")

    # 4.3 [ë¡œì§ ì‹¤í–‰] ìŠ¤ì¼€ì¤„ëŸ¬ ëŒ€ì‹  ì§ì ‘ í•¨ìˆ˜ í˜¸ì¶œ
    print(" -> ì¢€ë¹„ ê°ì§€ ë¡œì§ ìˆ˜ë™ ì‹¤í–‰ ì¤‘...")
    MonitoringService.check_zombies()

    # 4.4 [ê²°ê³¼ ê²€ì¦]
    db.refresh(user)
    if user.is_offline_notified:
        print_pass("âœ… ì¢€ë¹„ ê°ì§€ ì„±ê³µ: User.is_offline_notifiedê°€ Trueë¡œ ë³€ê²½ë¨")

        zombie_log = db.query(SystemLog).filter(
            SystemLog.type == "ZOMBIE_SMS",
            SystemLog.timestamp >= datetime.now() - timedelta(minutes=1)
        ).first()

        if zombie_log:
            print_pass(f"âœ… ë¬¸ìž ë°œì†¡ ë¡œê·¸ í™•ì¸: {zombie_log.message}")
        else:
            print_fail("ì¢€ë¹„ ê°ì§€ëŠ” ëëŠ”ë°, SMS ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        print_fail("âŒ ì¢€ë¹„ ê°ì§€ ì‹¤íŒ¨: ìƒíƒœê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    db.close()

    # ----------------------------------------------------
    # [Step 5] ê´€ë¦¬ìž ë°°í¬ ê¸°ëŠ¥
    # ----------------------------------------------------
    log("\n--- [5] ê´€ë¦¬ìž ë°°í¬ í…ŒìŠ¤íŠ¸ ---")

    new_ver = f"1.0.{uuid.uuid4().hex[:3]}"
    res = requests.post(f"{BASE_URL}/releases", headers=admin_headers, json={
        "version": new_ver,
        "description": "Auto Test Release",
        "download_url": "http://test.com",
        "is_mandatory": True
    })

    if res.status_code == 201:
        print_pass(f"ìƒˆ ë²„ì „ ë°°í¬ ì„±ê³µ ({new_ver})")
    else:
        print_fail(f"ë°°í¬ ì‹¤íŒ¨: {res.text}")

    res = requests.get(f"{BASE_URL}/releases")
    if res.status_code == 200:
        print_pass("ë²„ì „ ëª©ë¡ ì¡°íšŒ ì„±ê³µ")

    # ----------------------------------------------------
    # [Step 6] ì •ë¦¬
    # ----------------------------------------------------
    if os.path.exists(TEST_EXCEL_FILE):
        os.remove(TEST_EXCEL_FILE)
        log(f"\nðŸ—‘ï¸  í…ŒìŠ¤íŠ¸ íŒŒì¼ ì‚­ì œ ì™„ë£Œ")

    print(f"\n{GREEN}âœ¨ ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ! âœ¨{RESET}")


if __name__ == "__main__":
    run_complete_test()

==================================================
[File Path]: app\db.py
==================================================
ï»¿from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base # [ìˆ˜ì •] ìµœì‹  ë²„ì „ì— ë§žì¶° import ë°©ì‹ ì¡°ì •
from .settings import settings

# [ìˆ˜ì •] SQLiteì¼ ë•Œë§Œ check_same_thread ì˜µì…˜ ì ìš©
connect_args = {}
if settings.DATABASE_URL.startswith("sqlite"):
    connect_args = {"check_same_thread": False}

engine = create_engine(settings.DATABASE_URL, connect_args=connect_args)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

==================================================
[File Path]: app\main.py
==================================================
ï»¿import uvicorn
from contextlib import asynccontextmanager
from fastapi import FastAPI
from apscheduler.schedulers.background import BackgroundScheduler
from app.routers import system, auth, users, sales
from app.settings import settings
from app.services.monitoring import MonitoringService

# ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
scheduler = BackgroundScheduler(timezone=settings.TIMEZONE)

@asynccontextmanager
async def lifespan(app: FastAPI):
    # ì•± ì‹œìž‘ ì‹œ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œìž‘
    scheduler.add_job(MonitoringService.check_zombies, 'interval', minutes=1, id='check_zombies')
    scheduler.add_job(MonitoringService.daily_reset, 'cron', hour=0, minute=5, id='daily_reset')
    scheduler.start()
    print("--- [System] Monitoring Scheduler Started ---")
    yield
    scheduler.shutdown()
    print("--- [System] Monitoring Scheduler Shutdown ---")

app = FastAPI(title=settings.PROJECT_NAME, lifespan=lifespan)

# [ìˆ˜ì •ë¨] system ë¼ìš°í„°ì˜ prefixë¥¼ '/api/v1'ìœ¼ë¡œ ë³€ê²½ (ê¸°ì¡´ '/api/v1/system' ì œê±°)
app.include_router(system.router, prefix=settings.API_V1_STR, tags=["System & Reports"])

# ë‚˜ë¨¸ì§€ ë¼ìš°í„°ëŠ” ê¸°ì¡´ ìœ ì§€
app.include_router(auth.router, prefix=f"{settings.API_V1_STR}/auth", tags=["auth"])
app.include_router(users.router, prefix=f"{settings.API_V1_STR}/users", tags=["users"])
app.include_router(sales.router, prefix=f"{settings.API_V1_STR}/sales", tags=["sales"])

@app.get("/")
def root():
    return {"message": "Vegenie API Server is running"}

if __name__ == "__main__":
    uvicorn.run("app.main:app", host="0.0.0.0", port=8000, reload=True)

==================================================
[File Path]: app\settings.py
==================================================
ï»¿from pydantic_settings import BaseSettings
import os # [ì¶”ê°€]

class Settings(BaseSettings):
    PROJECT_NAME: str = "Vegenie"
    VERSION: str = "v0.2.5"
    API_V1_STR: str = "/api/v1"

    TIMEZONE: str = "Asia/Seoul"
    DATABASE_URL: str = "sqlite:///./vegenie.db"

    # ì—‘ì…€ íŒŒì‹± ê³„ì•½
    EXCEL_PASSWORD: str = "7055"
    EXCEL_SHEET_NAME: str = "ê²°ì œ í•©ê³„"

    # JWT ì„¤ì •
    SECRET_KEY: str = "vegenie-secret-key-change-this-in-prod"
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 60 * 24 * 7

    # --------------------------------------------------------
    # [G. ì•Œë¦¼/ìš´ì˜ ê³ ì •ê°’] - Solapi & Kakao Real Keys
    # --------------------------------------------------------
    # Solapi API Key
    SOLAPI_KEY: str = "NCS4COIDQ681XXPL"
    SOLAPI_SECRET: str = "4IWZDH2PMMQJXBZRDRA5Z7SQUTP8VFSX"

    # Kakao AlimTalk IDs
    KAKAO_PF_ID: str = "KA01PF251225055208641PWbN0JWVOo8"
    KAKAO_TEMPLATE_ID: str = "KA01TP2512271353576383sumVHXbRGu"

    # Phone Numbers
    MANAGER_PHONE: str = "01021123558"  # ìˆ˜ì‹ ìž
    SENDER_PHONE: str = "01021123558"  # ë°œì‹ ìž (Solapiì— ë“±ë¡ëœ ë²ˆí˜¸ì—¬ì•¼ í•¨)

    # [ìˆ˜ì •] í™˜ê²½ë³€ìˆ˜ 'DATABASE_URL'ì´ ìžˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ê¸°ì¡´ SQLite ì‚¬ìš© (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©)
    DATABASE_URL: str = os.getenv("DATABASE_URL", "sqlite:///./vegenie.db")

settings = Settings()

==================================================
[File Path]: app\__init__.py
==================================================


==================================================
[File Path]: app\controllers\auth_controller.py
==================================================
# app/controllers/auth_controller.py
from sqlalchemy.orm import Session
from fastapi import HTTPException, status
from app.models.models import User
from app.schemas.user_schema import UserCreate, UserLogin
from app.core.security import get_password_hash, verify_password, create_access_token
from app.settings import settings
from datetime import timedelta
from datetime import datetime

class AuthController:
    @staticmethod
    def register_user(db: Session, user_in: UserCreate):
        # 1. Username ì¤‘ë³µ ì²´í¬
        existing_user = db.query(User).filter(User.username == user_in.username).first()
        if existing_user:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail="Username already exists"
            )

        # 2. ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ë° User ê°ì²´ ìƒì„±
        # [cite_start]store_uuidëŠ” Modelì˜ default=uuid.uuid4()ì— ì˜í•´ ìžë™ ìƒì„± (ì„œë²„ ê¶Œìœ„) [cite: 19]
        db_user = User(
            username=user_in.username,
            password_hash=get_password_hash(user_in.password),
            phone=user_in.phone,
            store_name=user_in.store_name,
            role="OWNER"
        )

        db.add(db_user)
        db.commit()
        db.refresh(db_user)
        return db_user

    @staticmethod
    def login_user(db: Session, user_in: UserLogin):
        # 1. ìœ ì € ì¡°íšŒ
        user = db.query(User).filter(User.username == user_in.username).first()
        if not user:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Incorrect username or password",
            )

        # 2. ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
        if not verify_password(user_in.password, user.password_hash):
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Incorrect username or password",
            )

        # 3. í† í° ë°œê¸‰
        access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
        access_token = create_access_token(
            data={"sub": user.username, "user_id": user.id},  # user_id í¬í•¨
            expires_delta=access_token_expires
        )

        return {
            "access_token": access_token,
            "token_type": "bearer"
        }

    @staticmethod
    def process_heartbeat(db: Session, current_user: User):
        # 1. ë§ˆì§€ë§‰ ìˆ˜ì‹  ì‹œê°„ ê°±ì‹ 
        current_user.last_heartbeat = datetime.now()

        # 2. ì¢€ë¹„ ìƒíƒœì˜€ë‹¤ë©´ í•´ì œ (ìž¬ìˆ˜ì‹  ì‹œ is_offline_notified=False)
        if current_user.is_offline_notified:
            current_user.is_offline_notified = False

            # (ì„ íƒ) ë³µêµ¬ ë¡œê·¸ ë‚¨ê¸°ê¸°
            # MonitoringService.log_event(...)

        db.add(current_user)
        db.commit()
        db.refresh(current_user)

        return {
            "status": "alive",
            "last_heartbeat": str(current_user.last_heartbeat)
        }

==================================================
[File Path]: app\controllers\sales_controller.py
==================================================
# app/controllers/sales_controller.py
from datetime import date
from sqlalchemy.orm import Session
from fastapi import UploadFile, HTTPException
from app.models.models import User, SalesReport, SystemLog
from app.services.parser import ExcelParser
from app.services.notification import NotificationService

class SalesController:
    @staticmethod
    async def upload_sales(db: Session, current_user: User, file: UploadFile, report_date: date = None):
        # -------------------------------------------------------
        # [cite_start]Step 1) report_date í™•ì •/ê²€ì¦ (ì„œë²„ ê¶Œìœ„) [cite: 21]
        # -------------------------------------------------------
        server_today = date.today()

        if report_date is None:
            # ë¯¸ì œê³µ ì‹œ ì„œë²„ todayë¡œ í™•ì •
            final_date = server_today
        else:
            # ì œê³µ ì‹œ ê²€ì¦: ë¶ˆì¼ì¹˜ 400
            if report_date != server_today:
                raise HTTPException(status_code=400, detail="Report date must match server today.")
            final_date = report_date

        # -------------------------------------------------------
        # Step 2~5) ì—‘ì…€ íŒŒì‹± (ê¸°ì¡´ ë¡œì§ ë™ì¼)
        # -------------------------------------------------------
        try:
            parsed = await ExcelParser.parse_sales_file(file)
        except HTTPException as he:
            raise he  # 400 ì—ëŸ¬ëŠ” ê·¸ëŒ€ë¡œ ì „ë‹¬
        except Exception as e:
            db.add(SystemLog(type="UPLOAD", level="ERROR", source="SERVER", message=f"Parse Error: {str(e)}",
                             status="FAIL"))
            db.commit()
            raise HTTPException(status_code=400, detail="Excel parsing failed")

        # -------------------------------------------------------
        # [cite_start]Step 7) Total ìž¬ê³„ì‚° (SSOT) [cite: 9]
        # -------------------------------------------------------
        total = parsed["hall"] + parsed["baemin"] + parsed["coupang"] + parsed["yogiyo"]

        # -------------------------------------------------------
        # [cite_start]Step 6) sales_reports upsert [cite: 21]
        # -------------------------------------------------------
        report = db.query(SalesReport).filter(
            SalesReport.user_id == current_user.id,
            SalesReport.report_date == final_date
        ).first()

        if not report:
            report = SalesReport(user_id=current_user.id, report_date=final_date)

        report.hall = parsed["hall"]
        report.baemin = parsed["baemin"]
        report.coupang = parsed["coupang"]
        report.yogiyo = parsed["yogiyo"]
        report.total_sales = total

        db.add(report)
        db.commit()
        db.refresh(report)  # ID íšë“

        # -------------------------------------------------------
        # [cite_start]Step 8) report_notifications + ì•Œë¦¼í†¡ ë°œì†¡ [cite: 16]
        # ì •ì±…: ì•Œë¦¼ ì‹¤íŒ¨í•´ë„ ì—…ë¡œë“œëŠ” 200 ìœ ì§€ (Try-Except ë‚´ë¶€ ì²˜ë¦¬)
        # -------------------------------------------------------
        NotificationService.send_daily_report(db, current_user, report)

        # -------------------------------------------------------
        # [cite_start]Step 9) System Log [cite: 21]
        # -------------------------------------------------------
        db.add(SystemLog(
            type="UPLOAD",
            level="INFO",
            source="SERVER",
            message="Upload & Parsing Success",
            status="SUCCESS",
            meta=f'{{"report_id": {report.report_id}, "total": {total}}}'
        ))
        db.commit()

        return report

    @staticmethod
    def _log(db, level, msg, user):
        # ì‹œìŠ¤í…œ ë¡œê·¸ ì ìž¬ í—¬í¼ (ëª¨ë¸ì— SystemLogê°€ ìžˆì–´ì•¼ í•¨)
        try:
            log = SystemLog(
                type="UPLOAD",
                level=level,
                source="SERVER",
                message=msg,
                status="SUCCESS" if level == "INFO" else "FAIL",
                meta=f'{{"user_id": {user.id}}}'
            )
            db.add(log)
            # ì—¬ê¸°ì„œ commitì€ ë©”ì¸ íŠ¸ëžœìž­ì…˜ê³¼ í•¨ê»˜ ì²˜ë¦¬ë˜ë„ë¡ í•¨
        except:
            pass  # ë¡œê·¸ ì‹¤íŒ¨ê°€ ë¡œì§ì„ ë§‰ì§€ ì•Šê²Œ

==================================================
[File Path]: app\controllers\user_controller.py
==================================================
# app/controllers/user_controller.py
from sqlalchemy.orm import Session
from fastapi import HTTPException, status
from app.models.models import User
from app.schemas.user_schema import UserUpdate


class UserController:
    @staticmethod
    def get_me(current_user: User):
        # í˜„ìž¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìž ê°ì²´ ë°˜í™˜
        return current_user

    @staticmethod
    def update_profile(db: Session, current_user: User, user_in: UserUpdate):
        # ëª…ì„¸: phone/store_nameë§Œ ë³€ê²½ í—ˆìš© (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)
        # ìŠ¤í‚¤ë§ˆ(UserUpdate)ì—ì„œ ì´ë¯¸ í•„í„°ë§ë˜ì§€ë§Œ, ë¡œì§ì—ì„œë„ ëª…ì‹œì ìœ¼ë¡œ ì²˜ë¦¬

        updates_made = False

        if user_in.phone is not None:
            current_user.phone = user_in.phone
            updates_made = True

        if user_in.store_name is not None:
            current_user.store_name = user_in.store_name
            updates_made = True

        if updates_made:
            db.add(current_user)
            db.commit()
            db.refresh(current_user)

        return current_user

==================================================
[File Path]: app\controllers\__init__.py
==================================================


==================================================
[File Path]: app\core\deps.py
==================================================
# app/core/deps.py
from typing import Generator, Optional
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import jwt, JWTError
from sqlalchemy.orm import Session
from app.db import get_db
from app.models.models import User
from app.settings import settings

# í† í° URLì€ Swagger UIìš© (ì‹¤ì œë¡  /api/v1/auth/login)
oauth2_scheme = OAuth2PasswordBearer(tokenUrl=f"{settings.API_V1_STR}/auth/login")


def get_current_user(
        db: Session = Depends(get_db),
        token: str = Depends(oauth2_scheme)
) -> User:
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception

    user = db.query(User).filter(User.username == username).first()
    if user is None:
        raise credentials_exception
    return user

==================================================
[File Path]: app\core\security.py
==================================================
# app/core/security.py
from datetime import datetime, timedelta
from typing import Optional
from passlib.context import CryptContext
from jose import jwt
from app.settings import settings

# passlib + bcrypt í˜¸í™˜ì„± ì„¤ì •
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)


def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)


def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)

    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
    return encoded_jwt

==================================================
[File Path]: app\models\models.py
==================================================
ï»¿from sqlalchemy import Column, Integer, String, DateTime, Boolean, ForeignKey, UniqueConstraint, Date, Text
from sqlalchemy.sql import func
import uuid
from app.db import Base


class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, index=True)
    password_hash = Column(String)
    phone = Column(String)
    store_name = Column(String)
    store_uuid = Column(String, unique=True, default=lambda: str(uuid.uuid4()))
    role = Column(String, default="OWNER")
    last_heartbeat = Column(DateTime, nullable=True)
    is_offline_notified = Column(Boolean, default=False)
    created_at = Column(DateTime, server_default=func.now())


class SalesReport(Base):
    __tablename__ = "sales_reports"
    report_id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    report_date = Column(Date)
    hall = Column(Integer, default=0)
    baemin = Column(Integer, default=0)
    coupang = Column(Integer, default=0)
    yogiyo = Column(Integer, default=0)
    total_sales = Column(Integer, default=0)

    __table_args__ = (UniqueConstraint('user_id', 'report_date', name='_user_date_uc'),)


class SystemLog(Base):
    __tablename__ = "system_logs"
    log_id = Column(Integer, primary_key=True, index=True)
    type = Column(String)  # LOGIN, ERROR, ZOMBIE_SMS ë“±
    level = Column(String)  # INFO, WARN, ERROR
    source = Column(String)  # SERVER, CLIENT
    message = Column(String)
    status = Column(String)  # SUCCESS, FAIL
    meta = Column(String, nullable=True)  # JSON String
    timestamp = Column(DateTime, server_default=func.now())


class ReportNotification(Base):
    __tablename__ = "report_notifications"
    notif_id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    report_date = Column(Date)
    upload_status = Column(String, default="RECEIVED")
    primary_channel = Column(String, default="ALIMTALK")
    primary_status = Column(String, nullable=True)
    primary_body = Column(String, nullable=True)

    # [ìˆ˜ì •ë¨] ì´ í•„ë“œê°€ ì—†ì–´ì„œ ì—ëŸ¬ê°€ ë‚¬ìŠµë‹ˆë‹¤. ê¼­ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!
    error_message = Column(String, nullable=True)

    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())

    __table_args__ = (UniqueConstraint('user_id', 'report_date', name='_user_date_notif_uc'),)


# [ì‹ ê·œ ì¶”ê°€] ë²„ì „ ê´€ë¦¬ìš© í…Œì´ë¸”
class Release(Base):
    __tablename__ = "releases"

    id = Column(Integer, primary_key=True, index=True)
    version = Column(String, unique=True, index=True)  # ì˜ˆ: "1.0.2"
    description = Column(Text, nullable=True)  # ì—…ë°ì´íŠ¸ ë‚´ì—­
    download_url = Column(String, nullable=False)  # ì„¤ì¹˜íŒŒì¼ ê²½ë¡œ
    is_mandatory = Column(Boolean, default=False)  # ê°•ì œ ì—…ë°ì´íŠ¸ ì—¬ë¶€
    created_at = Column(DateTime, server_default=func.now())

==================================================
[File Path]: app\models\__init__.py
==================================================


==================================================
[File Path]: app\routers\auth.py
==================================================
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.db import get_db
from app.schemas.user_schema import UserCreate, UserResponse, UserLogin, Token
from app.controllers.auth_controller import AuthController
from app.models.models import User
from app.core.deps import get_current_user
from app.schemas.system import HeartbeatResponse

router = APIRouter()

@router.post("/register", response_model=UserResponse, status_code=201)
def register(user_in: UserCreate, db: Session = Depends(get_db)):
    """
    íšŒì›ê°€ìž… API
    - store_uuidëŠ” ì„œë²„ì—ì„œ ìžë™ ìƒì„±ë©ë‹ˆë‹¤.
    - passwordëŠ” bcryptë¡œ í•´ì‹±ë˜ì–´ ì €ìž¥ë©ë‹ˆë‹¤.
    """
    return AuthController.register_user(db, user_in)

@router.post("/login", response_model=Token)
def login(user_in: UserLogin, db: Session = Depends(get_db)):
    """
    ë¡œê·¸ì¸ API
    - JWT Access Tokenì„ ë°œê¸‰í•©ë‹ˆë‹¤.
    """
    return AuthController.login_user(db, user_in)

@router.post("/heartbeat", response_model=HeartbeatResponse)
def heartbeat(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    Heartbeat API
    - í´ë¼ì´ì–¸íŠ¸ëŠ” 1ë¶„ë§ˆë‹¤ ì´ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•¨.
    - í˜¸ì¶œ ì‹œ last_heartbeat ê°±ì‹  ë° ì¢€ë¹„ ìƒíƒœ í•´ì œ.
    """
    return AuthController.process_heartbeat(db, current_user)

==================================================
[File Path]: app\routers\sales.py
==================================================
from datetime import date, datetime, timedelta
import io
import openpyxl
from typing import Optional, List

from fastapi import APIRouter, Depends, File, UploadFile, Form, Query, HTTPException
from fastapi.responses import StreamingResponse
from sqlalchemy.orm import Session

from app.db import get_db
from app.models.models import User, SalesReport
from app.core.deps import get_current_user
from app.controllers.sales_controller import SalesController
from app.schemas.sales_schema import SalesReportResponse, MonthlySalesResponse, MonthlySalesSummary

router = APIRouter()


@router.post("/upload", response_model=SalesReportResponse)
async def upload_sales_report(
        report_date: Optional[date] = Form(None),
        file: UploadFile = File(...),
        db: Session = Depends(get_db),
        current_user: User = Depends(get_current_user)
):
    return await SalesController.upload_sales(db, current_user, file, report_date)


# [A5 ì¶”ê°€] ì›”ë³„ ë§¤ì¶œ ì¡°íšŒ
@router.get("/monthly", response_model=MonthlySalesResponse)
def get_monthly_sales(
        month: str = Query(..., description="YYYY-MM format"),
        db: Session = Depends(get_db),
        current_user: User = Depends(get_current_user)
):
    try:
        target_date = datetime.strptime(month, "%Y-%m")
    except ValueError:
        raise HTTPException(status_code=400, detail="Invalid month format. Use YYYY-MM")

    # ì›”ì˜ ì‹œìž‘ì¼ê³¼ ëì¼ ê³„ì‚°
    start_date = date(target_date.year, target_date.month, 1)
    if target_date.month == 12:
        end_date = date(target_date.year + 1, 1, 1) - timedelta(days=1)
    else:
        end_date = date(target_date.year, target_date.month + 1, 1) - timedelta(days=1)

    reports = db.query(SalesReport).filter(
        SalesReport.user_id == current_user.id,
        SalesReport.report_date >= start_date,
        SalesReport.report_date <= end_date
    ).order_by(SalesReport.report_date).all()

    daily_logs = []
    total_accumulated = 0

    for r in reports:
        total_accumulated += r.total_sales
        daily_logs.append(MonthlySalesSummary(
            date=str(r.report_date),
            total_sales=r.total_sales,
            platform_sales={
                "hall": r.hall,
                "baemin": r.baemin,
                "coupang": r.coupang,
                "yogiyo": r.yogiyo
            }
        ))

    return MonthlySalesResponse(
        month=month,
        total_accumulated=total_accumulated,
        daily_logs=daily_logs
    )


# [A5 ì¶”ê°€] ì—‘ì…€ ë‚´ë³´ë‚´ê¸° (ê¸°ê°„ ì§€ì •)
@router.get("/export")
def export_sales_excel(
        start: date,
        end: date,
        db: Session = Depends(get_db),
        current_user: User = Depends(get_current_user)
):
    # [cite_start]1. ì„œë²„ ìµœì¢… ë°©ì–´: ë¯¸ëž˜ ë‚ ì§œ ìš”ì²­ ì°¨ë‹¨ [cite: 21]
    if end > date.today():
        raise HTTPException(status_code=400, detail="Cannot export future data.")

    if start > end:
        raise HTTPException(status_code=400, detail="Start date cannot be after end date.")

    # 2. ë°ì´í„° ì¡°íšŒ
    reports = db.query(SalesReport).filter(
        SalesReport.user_id == current_user.id,
        SalesReport.report_date >= start,
        SalesReport.report_date <= end
    ).order_by(SalesReport.report_date).all()

    # 3. ì—‘ì…€ ìƒì„± (In-memory)
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "ë§¤ì¶œë‚´ì—­"
    ws.append(["ë‚ ì§œ", "ì´ë§¤ì¶œ", "í™€", "ë°°ë‹¬ì˜ë¯¼ì¡±", "ì¿ íŒ¡ì´ì¸ ", "ìš”ê¸°ìš”"])

    for r in reports:
        ws.append([str(r.report_date), r.total_sales, r.hall, r.baemin, r.coupang, r.yogiyo])

    output = io.BytesIO()
    wb.save(output)
    output.seek(0)

    filename = f"sales_{start}_{end}.xlsx"
    headers = {'Content-Disposition': f'attachment; filename="{filename}"'}

    return StreamingResponse(
        output,
        headers=headers,
        media_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

==================================================
[File Path]: app\routers\system.py
==================================================
ï»¿from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List
from datetime import date

from app.db import get_db
from app.models.models import User, ReportNotification, Release
from app.schemas.system import SystemVersion, ReportHistoryItem, ReportDetailResponse, ReleaseInfo, ReleaseCreate
from app.core.deps import get_current_user
from app.settings import settings

# [ì¤‘ìš”] ë¼ìš°í„° ìƒì„±
router = APIRouter()


# ---------------------------------------------------------
# 1. System Info (ê²½ë¡œ ëª…ì‹œ: /system/version)
# ---------------------------------------------------------
@router.get("/system/version", response_model=SystemVersion)
def get_version():
    return {
        "version": settings.VERSION,
        "status": "running",
        "timezone": settings.TIMEZONE
    }


# ---------------------------------------------------------
# 2. Reports (ê²½ë¡œ: /reports/...)
# ---------------------------------------------------------
@router.get("/reports/history", response_model=List[ReportHistoryItem])
def get_report_history(
        days: int = 10,
        db: Session = Depends(get_db),
        current_user: User = Depends(get_current_user)
):
    """ìµœê·¼ Nì¼ê°„ì˜ ë¦¬í¬íŠ¸ ì•Œë¦¼ ìƒíƒœ ìš”ì•½"""
    history = db.query(ReportNotification).filter(
        ReportNotification.user_id == current_user.id
    ).order_by(ReportNotification.report_date.desc()).limit(days).all()

    return [
        ReportHistoryItem(
            report_date=h.report_date,
            upload_status=h.upload_status,
            primary_status=h.primary_status,
            sent_at=h.updated_at
        ) for h in history
    ]


@router.get("/reports/history/{report_date}", response_model=ReportDetailResponse)
def get_report_detail(
        report_date: date,
        db: Session = Depends(get_db),
        current_user: User = Depends(get_current_user)
):
    """íŠ¹ì • ë‚ ì§œ ì•Œë¦¼ ìƒì„¸"""
    noti = db.query(ReportNotification).filter(
        ReportNotification.user_id == current_user.id,
        ReportNotification.report_date == report_date
    ).first()

    if not noti:
        raise HTTPException(status_code=404, detail="No report found for this date")

    return ReportDetailResponse(
        report_date=noti.report_date,
        upload_status=noti.upload_status,
        primary_status=noti.primary_status,
        sent_at=noti.updated_at,
        primary_body=noti.primary_body,
        error_message=noti.error_message
    )


# ---------------------------------------------------------
# 3. Releases (ê²½ë¡œ: /releases)
# ---------------------------------------------------------
@router.get("/releases", response_model=List[ReleaseInfo])
def get_releases(db: Session = Depends(get_db)):
    return db.query(Release).order_by(Release.id.desc()).all()


@router.post("/releases", response_model=ReleaseInfo, status_code=201)
def create_release(
        release_in: ReleaseCreate,
        db: Session = Depends(get_db),
        current_user: User = Depends(get_current_user)
):
    if current_user.role != "ADMIN":
        raise HTTPException(status_code=403, detail="Only admins can publish releases")

    existing = db.query(Release).filter(Release.version == release_in.version).first()
    if existing:
        raise HTTPException(status_code=400, detail="Version already exists")

    new_release = Release(
        version=release_in.version,
        description=release_in.description,
        download_url=release_in.download_url,
        is_mandatory=release_in.is_mandatory
    )
    db.add(new_release)
    db.commit()
    db.refresh(new_release)
    return new_release

==================================================
[File Path]: app\routers\users.py
==================================================
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.db import get_db
from app.schemas.user_schema import UserResponse, UserUpdate
from app.models.models import User
from app.controllers.user_controller import UserController

# [FIX] ì´ ì¤„ì´ ì—†ì–´ì„œ ì—ëŸ¬ê°€ ë‚¬ìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ì¶”ê°€í•´ì£¼ì„¸ìš”.
from app.core.deps import get_current_user

router = APIRouter()

@router.get("/me", response_model=UserResponse)
def read_users_me(current_user: User = Depends(get_current_user)):
    """
    ë‚´ ì •ë³´ ì¡°íšŒ (Authentication í•„ìˆ˜)
    """
    return UserController.get_me(current_user)

@router.put("/profile", response_model=UserResponse)
def update_user_profile(
    user_in: UserUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    í”„ë¡œí•„ ìˆ˜ì • (Authentication í•„ìˆ˜)
    """
    return UserController.update_profile(db, current_user, user_in)

==================================================
[File Path]: app\routers\__init__.py
==================================================


==================================================
[File Path]: app\schemas\sales_schema.py
==================================================
# app/schemas/sales_schema.py
from pydantic import BaseModel
from datetime import date
from typing import List, Dict

class SalesReportResponse(BaseModel):
    report_id: int
    report_date: date
    hall: int
    baemin: int
    coupang: int
    yogiyo: int
    total_sales: int

    class Config:
        from_attributes = True

# [A5 ì¶”ê°€] ì›”ë³„ ì¡°íšŒìš©
class MonthlySalesSummary(BaseModel):
    date: str       # "2025-01-01"
    total_sales: int
    platform_sales: Dict[str, int] # {"baemin": 1000, ...}

class MonthlySalesResponse(BaseModel):
    month: str      # "2025-01"
    total_accumulated: int
    daily_logs: List[MonthlySalesSummary]

==================================================
[File Path]: app\schemas\system.py
==================================================
ï»¿from pydantic import BaseModel
from typing import Optional, List
from datetime import date, datetime


class SystemVersion(BaseModel):
    version: str
    status: str
    timezone: str


class HeartbeatResponse(BaseModel):
    status: str
    last_heartbeat: str


# [A5] ë¦¬í¬íŠ¸ ì´ë ¥
class ReportHistoryItem(BaseModel):
    report_date: date
    upload_status: str
    primary_status: str
    sent_at: Optional[datetime]


class ReportDetailResponse(ReportHistoryItem):
    primary_body: Optional[str]
    error_message: Optional[str]


# [A5] ë¦´ë¦¬ì¦ˆ ì •ë³´
class ReleaseInfo(BaseModel):
    version: str
    description: Optional[str]
    download_url: str
    is_mandatory: bool
    created_at: datetime

    class Config:
        from_attributes = True


class ReleaseCreate(BaseModel):
    version: str
    # [ìˆ˜ì •] = None ì„ ì¶”ê°€í•˜ì—¬ ìž…ë ¥í•˜ì§€ ì•Šì•„ë„ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•Šê²Œ í•¨
    description: Optional[str] = None
    download_url: str
    is_mandatory: bool = False

==================================================
[File Path]: app\schemas\user_schema.py
==================================================
ï»¿from pydantic import BaseModel
from datetime import datetime
from typing import Optional

# [ê¸°ì¡´]
class UserBase(BaseModel):
    username: str
    phone: str
    store_name: str

class UserCreate(UserBase):
    password: str

class UserResponse(UserBase):
    id: int
    store_uuid: str
    created_at: datetime
    class Config:
        from_attributes = True

# [NEW] ë¡œê·¸ì¸ ë° í† í°
class UserLogin(BaseModel):
    username: str
    password: str

class Token(BaseModel):
    access_token: str
    token_type: str


# app/schemas/user_schema.py (ê¸°ì¡´ ë‚´ìš© ì•„ëž˜ì— ì¶”ê°€)

class UserUpdate(BaseModel):
    phone: Optional[str] = None
    store_name: Optional[str] = None

    # ê·¸ ì™¸ í•„ë“œ(username, role ë“±)ê°€ ë“¤ì–´ì˜¤ë©´ ì—ëŸ¬ë¥¼ ë±‰ê±°ë‚˜ ë¬´ì‹œí•˜ë„ë¡ ì„¤ì •
    # ëª…ì„¸ì˜ "ë³€ê²½ ê±°ë¶€"ë¥¼ í™•ì‹¤ížˆ í•˜ê¸° ìœ„í•´, Pydantic ë ˆë²¨ì—ì„œ í•„í„°ë§í•©ë‹ˆë‹¤.
    class Config:
        extra = "forbid"  # ì •ì˜ë˜ì§€ ì•Šì€ í•„ë“œê°€ ì˜¤ë©´ 422 Unprocessable Entity ë°œìƒ (ì‚¬ì‹¤ìƒ ê±°ë¶€)

==================================================
[File Path]: app\schemas\__init__.py
==================================================


==================================================
[File Path]: app\services\monitoring.py
==================================================
# app/services/monitoring.py
from datetime import datetime, timedelta
from sqlalchemy.orm import Session
from app.models.models import User, SystemLog
from app.db import SessionLocal
from app.settings import settings
from app.services.notification import NotificationService  # [ì¶”ê°€] ì‹¤ì œ ë°œì†¡ì„ ìœ„í•´ ìž„í¬íŠ¸


class MonitoringService:
    @staticmethod
    def log_event(db: Session, type: str, level: str, message: str, meta: str = None):
        """ì‹œìŠ¤í…œ ë¡œê·¸ ì ìž¬ í—¬í¼"""
        try:
            log = SystemLog(
                type=type,
                level=level,
                source="SERVER",
                message=message,
                status="SUCCESS",
                meta=meta
            )
            db.add(log)
            # ì—¬ê¸°ì„œ commit í•˜ì§€ ì•ŠìŒ (í˜¸ì¶œìžê°€ ì¼ê´„ commit í•˜ë„ë¡)
        except Exception as e:
            print(f"[Log Error] {e}")

    @staticmethod
    def send_zombie_alert(db: Session, user: User):
        """
        ì‹¤ì œ Solapi SMS ë°œì†¡ ë¡œì§ ì—°ë™
        """
        # NotificationServiceì— êµ¬í˜„ëœ 'ì•ˆì „í•œ íŒ¨í„´'ì˜ SMS ë°œì†¡ ë¡œì§ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
        # ì„±ê³µ ì‹œ True, ì‹¤íŒ¨ ì‹œ False ë°˜í™˜
        return NotificationService.send_zombie_alert(db, user)

    @staticmethod
    def check_zombies():
        """
        ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ 5ë¶„ ì´ìƒ í•˜íŠ¸ë¹„íŠ¸ê°€ ì—†ëŠ” ìœ ì €ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
        """
        db = SessionLocal()
        try:
            # ê¸°ì¤€: í˜„ìž¬ì‹œê°„ - 5ë¶„
            threshold = datetime.now() - timedelta(minutes=5)

            # ë””ë²„ê¹…: ì„œë²„ ì‹œê°„ í™•ì¸
            # print(f"[Monitoring] Checking at {datetime.now()} (Threshold: {threshold})")

            # ì¡°ê±´: í•˜íŠ¸ë¹„íŠ¸ê°€ 5ë¶„ ì „ì´ê³  + ì•„ì§ ì•Œë¦¼ì„ ì•ˆ ë³´ë‚¸(is_offline_notified=False) ìœ ì €
            zombies = db.query(User).filter(
                User.last_heartbeat < threshold,
                User.is_offline_notified == False
            ).all()

            if zombies:
                print(f"[Monitoring] Detected {len(zombies)} zombies.")

            for user in zombies:
                # 1. SMS ë°œì†¡ ì‹œë„ (NotificationService ìœ„ìž„)
                # db ì„¸ì…˜ì„ ê°™ì´ ë„˜ê²¨ì„œ ì‹œìŠ¤í…œ ë¡œê·¸ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìžˆê²Œ í•¨
                sent = MonitoringService.send_zombie_alert(db, user)

                if sent:
                    # 2. ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ë°œì†¡ ë°©ì§€)
                    user.is_offline_notified = True
                    db.add(user)

                    # 3. ì¶”ê°€ ë¡œê·¸ ì ìž¬ (A3 ìš”êµ¬ì‚¬í•­)
                    MonitoringService.log_event(
                        db,
                        type="ZOMBIE_SMS",
                        level="WARN",
                        message=f"Zombie detected & Sent: {user.username} ({user.store_name})",
                        meta=f'{{"user_id": {user.id}}}'
                    )
                else:
                    # ì‹¤íŒ¨ ì‹œ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³ , is_offline_notifiedëŠ” False ìœ ì§€ (ë‹¤ìŒ ì£¼ê¸°ì— ìž¬ì‹œë„)
                    print(f"[Monitoring] Failed to send SMS to {user.store_name}")

            # ë³€ê²½ì‚¬í•­ ì¼ê´„ ì €ìž¥
            db.commit()

        except Exception as e:
            print(f"[Monitoring Error] {e}")
            db.rollback()
        finally:
            db.close()

    @staticmethod
    def daily_reset():
        """
        [ëª…ì„¸] í•˜ë£¨ 1íšŒ Zombie SMS + 00:05 ë¦¬ì…‹
        00:05ì— ì‹¤í–‰ë˜ì–´ ì•Œë¦¼ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        """
        print("[Scheduler] Daily Reset Logic Executed at 00:05")

        db = SessionLocal()
        try:
            # ëª¨ë“  ìœ ì €ì˜ ì•Œë¦¼ ìƒíƒœë¥¼ ì´ˆê¸°í™” (ë‚´ì¼ ë‹¤ì‹œ ì•Œë¦¼ ë°›ì„ ìˆ˜ ìžˆê²Œ)
            db.query(User).update({User.is_offline_notified: False})
            db.commit()
            print("[Scheduler] All users' offline status reset to False.")
        except Exception as e:
            print(f"[Reset Error] {e}")
            db.rollback()
        finally:
            db.close()

==================================================
[File Path]: app\services\notification.py
==================================================
import requests
import json
import datetime
import hmac
import hashlib
import uuid
from sqlalchemy.orm import Session
from app.models.models import ReportNotification, User, SalesReport, SystemLog
from app.settings import settings


class NotificationService:
    # ------------------------------------------------------------------
    # [1] ì•Œë¦¼í†¡ ê´€ë ¨ ë¡œì§ (ì¼ì¼ ë§¤ì¶œ ë³´ê³  -> ê´€ë¦¬ìžì—ê²Œ ì „ì†¡)
    # ------------------------------------------------------------------
    @staticmethod
    def _get_solapi_header():
        """ì•Œë¦¼í†¡ìš© í—¤ë” ìƒì„±ê¸°"""
        date_str = datetime.datetime.now(datetime.timezone.utc).isoformat()
        salt = str(uuid.uuid4())
        data = date_str + salt
        signature = hmac.new(
            key=settings.SOLAPI_SECRET.encode("utf-8"),
            msg=data.encode("utf-8"),
            digestmod=hashlib.sha256
        ).hexdigest()
        return {
            "Authorization": f"HMAC-SHA256 apiKey={settings.SOLAPI_KEY}, date={date_str}, salt={salt}, signature={signature}",
            "Content-Type": "application/json"
        }

    @staticmethod
    def send_daily_report(db: Session, user: User, report: SalesReport):
        """
        [ì¼ì¼ ë§¤ì¶œ ë³´ê³ ] -> ì•Œë¦¼í†¡
        ìˆ˜ì‹ ìž: settings.MANAGER_PHONE (ê´€ë¦¬ìž)
        """
        body = (
            f"[{user.store_name}] {report.report_date} ì¼ì¼ë§¤ì¶œ\n"
            f"ì´ : {report.total_sales:,}\n\n"
            f"í™€ : {report.hall:,}\n"
            f"ë°°ë¯¼ : {report.baemin:,}\n"
            f"ì¿ íŒ¡ : {report.coupang:,}\n"
            f"ìš”ê¸°ìš” : {report.yogiyo:,}\n"
            f"ìž…ë‹ˆë‹¤."
        )

        # ì´ë¯¸ ë³´ë‚¸ ì´ë ¥ì´ ìžˆëŠ”ì§€ í™•ì¸
        notif = db.query(ReportNotification).filter(
            ReportNotification.user_id == user.id,
            ReportNotification.report_date == report.report_date
        ).first()

        if not notif:
            notif = ReportNotification(
                user_id=user.id,
                report_date=report.report_date,
                upload_status="RECEIVED",
                primary_channel="ALIMTALK"
            )
            db.add(notif)

        try:
            # ì•Œë¦¼í†¡ ë°œì†¡ ë¡œì§
            url = "https://api.solapi.com/messages/v4/send"
            headers = NotificationService._get_solapi_header()
            data = {
                "message": {
                    "to": settings.MANAGER_PHONE,  # [ìœ ì§€] ë§¤ì¶œ ë¦¬í¬íŠ¸ëŠ” ê´€ë¦¬ìžì—ê²Œ
                    "from": settings.SENDER_PHONE,
                    "text": body,
                    "kakaoOptions": {
                        "pfId": settings.KAKAO_PF_ID,
                        "templateId": settings.KAKAO_TEMPLATE_ID,
                        "disableSms": True
                    }
                }
            }
            resp = requests.post(url, headers=headers, json=data).json()

            notif.primary_status = "SENT"
            notif.primary_body = body
            notif.provider_message_id = resp.get("messageId")
            notif.updated_at = datetime.datetime.now()

            # ì‹œìŠ¤í…œ ë¡œê·¸ ê¸°ë¡
            db.add(SystemLog(type="ALIMTALK", level="INFO", source="SERVER", message="Daily report sent",
                             status="SUCCESS"))
            print(f"[ALIMTALK SUCCESS] MessageId: {resp.get('messageId')}")

        except Exception as e:
            error_msg = str(e)
            notif.primary_status = "FAIL"
            notif.error_message = error_msg
            notif.updated_at = datetime.datetime.now()

            db.add(
                SystemLog(type="ALIMTALK", level="ERROR", source="SERVER", message=f"Fail: {error_msg}", status="FAIL"))
            print(f"[ALIMTALK FAIL] {error_msg}")

        db.commit()

    # ------------------------------------------------------------------
    # [2] ì¢€ë¹„ ì•Œë¦¼ ë¡œì§ (PC êº¼ì§ ê°ì§€ -> ì‚¬ìž¥ë‹˜ì—ê²Œ ì „ì†¡)
    # ------------------------------------------------------------------
    @staticmethod
    def send_zombie_alert(db: Session, user: User):
        """
        [ì¢€ë¹„ ì™€ì³ ì•Œë¦¼]
        ìˆ˜ì‹ ìž: user.phone (í•´ë‹¹ ë§¤ìž¥ ì‚¬ìž¥ë‹˜)
        """
        print(f"\n=== ðŸ§Ÿ ì¢€ë¹„ ì•Œë¦¼ ë°œì†¡ ì‹œìž‘ (To Owner) ===")

        # [ì•ˆì „ìž¥ì¹˜] ì‚¬ìž¥ë‹˜ ì „í™”ë²ˆí˜¸ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
        if not user.phone:
            error_msg = f"User {user.username} ({user.store_name}) has no phone number."
            print(f"[ZOMBIE FAIL] {error_msg}")
            db.add(SystemLog(type="ZOMBIE_SMS", level="ERROR", source="SERVER", message=error_msg, status="FAIL"))
            db.commit()
            return False

        # [ë©”ì‹œì§€ ë‚´ìš©]
        text_body = f"[{user.store_name}] ë² ì§€ë‚˜ì´ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¼œì£¼ì„¸ìš”."

        try:
            # (1) í—¤ë” ìƒì„±
            date_str = datetime.datetime.now(datetime.timezone.utc).isoformat()
            salt = str(uuid.uuid4())
            data = date_str + salt
            signature = hmac.new(
                key=settings.SOLAPI_SECRET.encode("utf-8"),
                msg=data.encode("utf-8"),
                digestmod=hashlib.sha256
            ).hexdigest()

            headers = {
                "Authorization": f"HMAC-SHA256 apiKey={settings.SOLAPI_KEY}, date={date_str}, salt={salt}, signature={signature}",
                "Content-Type": "application/json"
            }

            # (2) íŽ˜ì´ë¡œë“œ êµ¬ì„±
            body = {
                "message": {
                    "to": user.phone,  # [ìˆ˜ì •ë¨] ì‚¬ìž¥ë‹˜ ë³¸ì¸ íœ´ëŒ€í° ë²ˆí˜¸
                    "from": settings.SENDER_PHONE,  # ë°œì‹ ìžëŠ” ì„¤ì •ëœ ë²ˆí˜¸ (ëŒ€í‘œë²ˆí˜¸ ë“±)
                    "text": text_body,
                    "type": "SMS"
                }
            }

            # [ë””ë²„ê¹…]
            print(f"   - From: {settings.SENDER_PHONE}")
            print(f"   - To: {user.phone} (ì‚¬ìž¥ë‹˜)")
            print(f"   - Text: {text_body}")

            # (3) ë°œì†¡
            url = "https://api.solapi.com/messages/v4/send"
            res = requests.post(url, headers=headers, json=body)

            if res.status_code != 200:
                raise Exception(f"Solapi API Error: {res.text}")

            resp = res.json()

            # ë¡œê·¸ ê¸°ë¡
            db.add(SystemLog(
                type="ZOMBIE_SMS",
                level="WARN",
                source="SERVER",
                message=f"Zombie Alert sent to {user.store_name}",
                status="SUCCESS",
                meta=f'{{"user_id": {user.id}, "phone": "{user.phone}"}}'
            ))
            db.commit()
            print(f"[ZOMBIE SMS SUCCESS] MessageId: {resp.get('messageId')}")
            return True

        except Exception as e:
            print(f"[ZOMBIE SMS FAIL] {str(e)}")
            db.add(SystemLog(type="ZOMBIE_SMS", level="ERROR", source="SERVER", message=str(e), status="FAIL"))
            db.commit()
            return False

==================================================
[File Path]: app\services\parser.py
==================================================
import io
import msoffcrypto
import pandas as pd
import openpyxl
from datetime import date, datetime  # [ì¶”ê°€] ë‚ ì§œ ë¹„êµìš©
from fastapi import UploadFile, HTTPException
from app.settings import settings


class ExcelParser:
    @staticmethod
    async def parse_sales_file(file: UploadFile):
        # 1. íŒŒì¼ ì¤€ë¹„
        file_content = await file.read()
        file_io = io.BytesIO(file_content)
        decrypted = io.BytesIO()
        try:
            office_file = msoffcrypto.OfficeFile(file_io)
            office_file.load_key(password=settings.EXCEL_PASSWORD)
            office_file.decrypt(decrypted)
            decrypted.seek(0)
        except Exception:
            file_io.seek(0)
            decrypted = file_io

        # 2. ì—‘ì…€ ì½ê¸°
        try:
            df = pd.read_excel(decrypted, sheet_name=settings.EXCEL_SHEET_NAME, header=None)
        except Exception as e:
            raise HTTPException(status_code=400, detail=f"Excel parsing error: {str(e)}")

        # 3. í—¤ë” ì°¾ê¸° (í‚¤ì›Œë“œ ê¸°ë°˜)
        header_row_idx = -1
        keywords = ["ì¹´ë“œ", "í˜„ê¸ˆ", "ë°°ë¯¼", "ë°°ë‹¬", "ì¿ íŒ¡", "ìš”ê¸°ìš”", "ì´ì²´", "KBêµ­ë¯¼ì¹´ë“œ", "ì‹ í•œì¹´ë“œ", "ë¹„ì”¨ì¹´ë“œ"]

        for r_idx, row in df.iterrows():
            row_str = " ".join([str(val) for val in row if pd.notna(val)])
            if any(k in row_str for k in keywords):
                header_row_idx = r_idx
                break

        if header_row_idx == -1:
            for r_idx, row in df.iterrows():
                if "ë§¤ìž…ì‚¬ë³„" in " ".join([str(val) for val in row if pd.notna(val)]):
                    if r_idx + 1 < len(df):
                        header_row_idx = r_idx + 1
                        break
            if header_row_idx == -1:
                raise HTTPException(status_code=400, detail="Cannot find header row.")

        # 4. ë°ì´í„° í–‰ ì¶”ì¶œ
        if header_row_idx + 1 >= len(df):
            return {"hall": 0, "baemin": 0, "coupang": 0, "yogiyo": 0}

        header_row = df.iloc[header_row_idx]

        # [NEW] ë°ì´í„° ë‚ ì§œ ê²€ì¦ ë¡œì§ ì‹œìž‘ =================================
        # í—¤ë” ë°”ë¡œ ì•„ëž«ì¤„ì´ ë°ì´í„°ë¼ê³  ê°€ì •í•˜ê³ , ì²« ë²ˆì§¸ ì»¬ëŸ¼(0ë²ˆ)ì„ ë‚ ì§œë¡œ í™•ì¸
        data_row = df.iloc[header_row_idx + 1]

        try:
            raw_date = data_row[0]  # ì²« ë²ˆì§¸ ì¹¸ ê°€ì ¸ì˜¤ê¸°
            excel_date = None

            # 1) ì´ë¯¸ ë‚ ì§œ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            if isinstance(raw_date, (pd.Timestamp, datetime, date)):
                excel_date = raw_date.date() if isinstance(raw_date, (pd.Timestamp, datetime)) else raw_date

            # 2) ë¬¸ìžì—´ì´ë©´ íŒŒì‹± ì‹œë„ ("2026-01-12" or "2026.01.12")
            elif isinstance(raw_date, str):
                clean_date_str = raw_date.strip().replace('.', '-')
                excel_date = datetime.strptime(clean_date_str, "%Y-%m-%d").date()

            # 3) ê²€ì¦: ì—‘ì…€ ë‚ ì§œ vs ì˜¤ëŠ˜ ë‚ ì§œ
            if excel_date:
                server_today = date.today()
                if excel_date != server_today:
                    print(f"âŒ ë‚ ì§œ ë¶ˆì¼ì¹˜ ì°¨ë‹¨! ì—‘ì…€: {excel_date}, ì„œë²„: {server_today}")
                    raise HTTPException(
                        status_code=400,
                        detail=f"Report date mismatch. File date: {excel_date}, Today: {server_today}"
                    )
                else:
                    print(f"âœ… ë‚ ì§œ ê²€ì¦ í†µê³¼: {excel_date}")

        except HTTPException as he:
            raise he  # ë¶ˆì¼ì¹˜ ì—ëŸ¬ëŠ” ê·¸ëŒ€ë¡œ ë˜ì§
        except Exception as e:
            # ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨ ì‹œ: ì¼ë‹¨ ê²½ê³ ë§Œ í•˜ê³  ë„˜ì–´ê°€ê±°ë‚˜, ì •ì±…ì— ë”°ë¼ ë§‰ì„ ìˆ˜ë„ ìžˆìŒ
            # ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ ë¡œê·¸ë§Œ ì°ê³  ë„˜ì–´ê°‘ë‹ˆë‹¤. (ì–‘ì‹ì´ ë‹¤ë¥¼ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ)
            print(f"âš ï¸ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨ (ê²€ì¦ ê±´ë„ˆëœ€): {e}")
        # =================================================================

        # 5. ë°ì´í„° íŒŒì‹± ë° í•©ì‚°
        result = {"hall": 0, "baemin": 0, "coupang": 0, "yogiyo": 0}

        for i in range(header_row_idx + 1, len(df)):
            data_row = df.iloc[i]
            row_str = " ".join([str(v) for v in data_row if pd.notna(v)])
            if not row_str or "í•©ê³„" in row_str or "ì†Œê³„" in row_str: continue

            for col_idx in range(len(header_row)):
                col_name = str(header_row[col_idx]).strip()
                raw_val = data_row[col_idx]

                if pd.isna(col_name) or pd.isna(raw_val) or col_name == 'nan': continue

                # ì¤‘ë³µ ì»¬ëŸ¼ ë¸”ëž™ë¦¬ìŠ¤íŠ¸
                if col_name in ["ì¹´ë“œ", "QRê²°ì œ", "ì‹ ìš©ì¹´ë“œ", "ê²°ì œí•©ê³„"]: continue
                if "ê¸ˆì•¡" in col_name or "ê±´ìˆ˜" in col_name or "ì´ê³„" in col_name: continue

                # ê¸ˆì•¡ ë³€í™˜
                amount = 0
                try:
                    if isinstance(raw_val, (int, float)):
                        amount = int(raw_val)
                    else:
                        clean_str = str(raw_val).replace(",", "").replace("ì›", "").strip()
                        if clean_str.lstrip('-').isdigit():
                            amount = int(clean_str)
                except:
                    continue

                if amount == 0: continue

                # ë¶„ë¥˜ ë¡œì§
                if "ë°°ë‹¬ì˜ë¯¼ì¡±" in col_name or "ë°°ë¯¼" in col_name:
                    result["baemin"] += amount
                elif "ì¿ íŒ¡" in col_name or "coupang" in col_name:
                    result["coupang"] += amount
                elif "ìš”ê¸°ìš”" in col_name or "yogiyo" in col_name:
                    result["yogiyo"] += amount
                else:
                    result["hall"] += amount

        return result

==================================================
[File Path]: app\services\__init__.py
==================================================

